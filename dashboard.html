<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>ğŸ“Š ì§ì—…ê³„ê³  ëŒ€ì‹œë³´ë“œ (ë°ì´í„° ëª¨ë‹ˆí„°ë§)</title>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="firebase-config.js"></script>
  <style>
    .section { margin-bottom: 40px; }
    .inline { display: inline-block; margin-right: 10px; }
  </style>
</head>
<body>
  <h2>ğŸ“Š ì§ì—…ê³„ê³  ëŒ€ì‹œë³´ë“œ (ë°ì´í„° ëª¨ë‹ˆí„°ë§)</h2>

  <div class="section">
    <label>ì—°ë„:</label>
    <select id="yearSelect"></select>

    <label>ì¹´í…Œê³ ë¦¬ êµ¬ë¶„:</label>
    <select id="mainCategory" onchange="updateSubCategoryOptions()">
      <option value="ê¸°ë³¸ì •ë³´">ê¸°ë³¸ì •ë³´</option>
      <option value="ì‚¬ì—…ëª…">ì‚¬ì—…ëª…</option>
    </select>

    <span id="subCategoryWrapper" class="inline"></span>
    <span id="finalCategoryWrapper" class="inline"></span>

    <button onclick="loadFilteredData()">ì„ íƒ í•­ëª© ë³´ê¸°</button>
    <button onclick="logout()">ë¡œê·¸ì•„ì›ƒ</button>
    <br>
    <canvas id="chart" width="600" height="300"></canvas>
  </div>

  <div class="section">
    <h3>ğŸ“Š ì—°ë„ë³„ í•­ëª© ë¹„êµ</h3>
    <label>í•™êµ:</label>
    <select id="compareSchool"></select>
  
    <label>ì¹´í…Œê³ ë¦¬ êµ¬ë¶„:</label>
    <select id="compareMainCategory" onchange="updateCompareSubCategoryOptions()">
      <option value="ê¸°ë³¸ì •ë³´">ê¸°ë³¸ì •ë³´</option>
      <option value="ì‚¬ì—…ëª…">ì‚¬ì—…ëª…</option>
    </select>
  
    <span id="compareSubCategoryWrapper" class="inline"></span>
    <span id="compareFinalCategoryWrapper" class="inline"></span>
  
    <label>ì—°ë„ ë²”ìœ„:</label>
    <select id="compareStartYear"></select> ~
    <select id="compareEndYear"></select>
  
    <button onclick="compareAcrossYears()">ì—°ë„ ë¹„êµ</button>
    <canvas id="compareChart" width="600" height="300"></canvas>
  </div>
  

  <script>
    const yearSelect = document.getElementById("yearSelect");
    const mainCategory = document.getElementById("mainCategory");
    const subCategoryWrapper = document.getElementById("subCategoryWrapper");
    const finalCategoryWrapper = document.getElementById("finalCategoryWrapper");

    let chartInstance = null;
    let schoolDataSnapshot = null;
    let availableYears = [];

    firebase.auth().onAuthStateChanged(user => {
      if (!user) {
        alert("ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.");
        window.location.href = "index.html";
        return;
      }
      loadInitialData();
    });

    function logout() {
      firebase.auth().signOut().then(() => {
        alert("ë¡œê·¸ì•„ì›ƒ ë˜ì—ˆìŠµë‹ˆë‹¤.");
        window.location.href = "index.html";
      });
    }

    function loadInitialData() {
      firebase.database().ref("schoolData").once("value", snapshot => {
        schoolDataSnapshot = snapshot;
        const yearSet = new Set();
        snapshot.forEach(schoolSnap => {
          const years = schoolSnap.val();
          for (let year in years) {
            yearSet.add(year);
          }
        });
        availableYears = [...yearSet].sort();
        yearSelect.innerHTML = availableYears.map(y => `<option value="${y}"${y === '2024' ? ' selected' : ''}>${y}</option>`).join("");
        updateSubCategoryOptions();
        fillCompareYearDropdowns();
        fillCompareSchools();
        updateCompareSubCategoryOptions();
      });
    }

    function updateSubCategoryOptions() {
        const type = mainCategory.value;
        let optionsHTML = "";
        const selectedYear = yearSelect.value;

        if (type === "ê¸°ë³¸ì •ë³´") {
            optionsHTML = `
            <label>í•­ëª©:</label>
            <select id="subCategorySelect" onchange="setFinalCategory()">
                <option value="ì·¨ì—…ë¥ ">ì·¨ì—…ë¥ </option>
                <option value="ì‹¤ìŠµì‹¤ìˆ˜">ì‹¤ìŠµì‹¤ìˆ˜</option>
                <option value="ì·¨ì—…ììˆ˜">ì·¨ì—…ììˆ˜</option>
            </select>`;
            finalCategoryWrapper.innerHTML = "";
        }

        else if (type === "ì‚¬ì—…ëª…") {
            const businessSet = new Set();

            schoolDataSnapshot.forEach(snap => {
            const yearData = snap.val()[selectedYear];
            if (yearData && yearData["ì‚¬ì—…ëª…"]) {
                Object.keys(yearData["ì‚¬ì—…ëª…"]).forEach(biz => businessSet.add(biz));
            }
            });

            const businessOptions = Array.from(businessSet).map(biz => `<option value="${biz}">${biz}</option>`).join("");

            optionsHTML = `
            <label>ì‚¬ì—…ëª…:</label>
            <select id="subCategorySelect" onchange="setFinalCategory()">
                ${businessOptions}
            </select>`;

            finalCategoryWrapper.innerHTML = ""; // ì´ˆê¸°í™” í›„ í•˜ìœ„ ì˜µì…˜ ì„¤ì •ì€ setFinalCategory()ì—ì„œ ì²˜ë¦¬
        }

        subCategoryWrapper.innerHTML = optionsHTML;
        setFinalCategory();
        }


    function setFinalCategory() {
      const type = mainCategory.value;
      const sub = document.getElementById("subCategorySelect").value;

      if (type === "ê¸°ë³¸ì •ë³´") return;

      const options = `<label>í•­ëª©:</label><select id="finalCategorySelect">
        <option value="í†µí•©ì‚¬ì—…ì•¡">í†µí•©ì‚¬ì—…ì•¡</option>
        <option value="êµë¶€ì•¡">êµë¶€ì•¡</option>
        <option value="ì‚¬ìš©ì•¡">ì‚¬ìš©ì•¡</option>
        <option value="ë°˜ë‚©ì•¡">ë°˜ë‚©ì•¡</option>
        </select>`;

      finalCategoryWrapper.innerHTML = options;
    }

    function getValueFromPath(data, pathArray) {
      return pathArray.reduce((acc, cur) => acc && acc[cur], data);
    }

    function loadFilteredData() {
      const year = yearSelect.value;
      const type = mainCategory.value;
      const sub = document.getElementById("subCategorySelect").value;

      if (type === "ê¸°ë³¸ì •ë³´") {
        const path = ["ê¸°ë³¸ì •ë³´", sub];
        loadSingleDataset(path, `${year}ë…„ ${path.join("/")}`);
      } else {
        const final = document.getElementById("finalCategorySelect").value;
        if (final === "í†µí•©ì‚¬ì—…ì•¡") {
          loadMultipleDataset(["ì‚¬ì—…ëª…", sub], ["êµë¶€ì•¡", "ì‚¬ìš©ì•¡", "ë°˜ë‚©ì•¡"], year);
        } else {
          const path = ["ì‚¬ì—…ëª…", sub, final];
          loadSingleDataset(path, `${year}ë…„ ${path.join("/")}`);
        }
      }
    }

    function loadSingleDataset(path, title) {
      const labels = [];
      const values = [];
      const year = yearSelect.value;

      schoolDataSnapshot.forEach(snap => {
        const school = snap.key;
        const data = snap.val();
        const yearData = data?.[year];
        if (!yearData) return;
        const value = getValueFromPath(yearData, path);
        if (value !== undefined) {
          labels.push(school);
          values.push(value);
        }
      });

      drawChart(labels, [{ label: title, data: values }], title);
    }

    function loadMultipleDataset(basePath, keys, year) {
      const labels = [];
      const datasets = keys.map(key => ({ label: key, data: [] }));

      schoolDataSnapshot.forEach(snap => {
        const school = snap.key;
        const data = snap.val();
        const yearData = data?.[year];
        if (!yearData) return;
        labels.push(school);

        keys.forEach((key, idx) => {
          const value = getValueFromPath(yearData, [...basePath, key]);
          datasets[idx].data.push(value !== undefined ? value : 0);
        });
      });

      drawChart(labels, datasets, `${year}ë…„ ${basePath[1]} í†µí•©ì‚¬ì—…ì•¡`);
    }

    function drawChart(labels, datasets, title) {
      const ctx = document.getElementById("chart").getContext("2d");
      if (chartInstance) chartInstance.destroy();
      chartInstance = new Chart(ctx, {
        type: 'bar',
        data: { labels, datasets },
        options: {
          responsive: true,
          plugins: {
            legend: { position: 'top' },
            title: { display: true, text: title }
          }
        }
      });
    }

    let compareChartInstance = null;

    function fillCompareYearDropdowns() {
    const start = document.getElementById("compareStartYear");
    const end = document.getElementById("compareEndYear");
    const options = availableYears.map(y => `<option value="${y}">${y}</option>`).join("");

    start.innerHTML = options;
    end.innerHTML = options;
    start.value = "2022";
    end.value = "2024";
    }

    function fillCompareSchools() {
    const compareSchool = document.getElementById("compareSchool");
    const schoolSet = new Set();
    schoolDataSnapshot.forEach(snap => {
        schoolSet.add(snap.key);
    });
    compareSchool.innerHTML = Array.from(schoolSet)
        .map(name => `<option value="${name}">${name}</option>`)
        .join("");
    }

    function updateCompareSubCategoryOptions() {
    const type = document.getElementById("compareMainCategory").value;
    const year = document.getElementById("compareStartYear").value;
    const subWrapper = document.getElementById("compareSubCategoryWrapper");
    const finalWrapper = document.getElementById("compareFinalCategoryWrapper");

    if (type === "ê¸°ë³¸ì •ë³´") {
        subWrapper.innerHTML = `<label>í•­ëª©:</label>
        <select id="compareSubCategorySelect">
            <option value="ì·¨ì—…ë¥ ">ì·¨ì—…ë¥ </option>
            <option value="ì‹¤ìŠµì‹¤ìˆ˜">ì‹¤ìŠµì‹¤ìˆ˜</option>
            <option value="ì·¨ì—…ììˆ˜">ì·¨ì—…ììˆ˜</option>
        </select>`;
        finalWrapper.innerHTML = "";
    } else {
        const businessSet = new Set();
        schoolDataSnapshot.forEach(snap => {
        const yearData = snap.val()[year];
        if (yearData && yearData["ì‚¬ì—…ëª…"]) {
            Object.keys(yearData["ì‚¬ì—…ëª…"]).forEach(biz => businessSet.add(biz));
        }
        });

        const options = Array.from(businessSet)
        .map(b => `<option value="${b}">${b}</option>`)
        .join("");

        subWrapper.innerHTML = `<label>ì‚¬ì—…ëª…:</label>
        <select id="compareSubCategorySelect" onchange="updateCompareFinalCategoryOptions()">
            ${options}
        </select>`;
        updateCompareFinalCategoryOptions();
    }
    }

    function updateCompareFinalCategoryOptions() {
    const wrapper = document.getElementById("compareFinalCategoryWrapper");
    wrapper.innerHTML = `<label>í•­ëª©:</label>
        <select id="compareFinalCategorySelect">
        <option value="í†µí•©ì‚¬ì—…ì•¡">í†µí•©ì‚¬ì—…ì•¡</option>
        <option value="êµë¶€ì•¡">êµë¶€ì•¡</option>
        <option value="ì‚¬ìš©ì•¡">ì‚¬ìš©ì•¡</option>
        <option value="ë°˜ë‚©ì•¡">ë°˜ë‚©ì•¡</option>
        </select>`;
    }

    function compareAcrossYears() {
    const school = document.getElementById("compareSchool").value;
    const type = document.getElementById("compareMainCategory").value;
    const sub = document.getElementById("compareSubCategorySelect").value;
    const startYear = parseInt(document.getElementById("compareStartYear").value);
    const endYear = parseInt(document.getElementById("compareEndYear").value);
    const data = schoolDataSnapshot.child(school).val();

    const labels = [];
    const datasets = [];

    if (type === "ê¸°ë³¸ì •ë³´") {
        const values = [];
        for (let y = startYear; y <= endYear; y++) {
        const value = data?.[y]?.ê¸°ë³¸ì •ë³´?.[sub];
        labels.push(`${y}`);
        values.push(value ?? 0);
        }
        datasets.push({ label: `${school} - ${sub}`, data: values });
    } else {
        const final = document.getElementById("compareFinalCategorySelect").value;
        if (final === "í†µí•©ì‚¬ì—…ì•¡") {
        const items = ["êµë¶€ì•¡", "ì‚¬ìš©ì•¡", "ë°˜ë‚©ì•¡"];
        items.forEach(item => {
            const values = [];
            for (let y = startYear; y <= endYear; y++) {
            const value = data?.[y]?.["ì‚¬ì—…ëª…"]?.[sub]?.[item];
            labels.includes(`${y}`) || labels.push(`${y}`);
            values.push(value ?? 0);
            }
            datasets.push({ label: item, data: values });
        });
        } else {
        const values = [];
        for (let y = startYear; y <= endYear; y++) {
            const value = data?.[y]?.["ì‚¬ì—…ëª…"]?.[sub]?.[final];
            labels.push(`${y}`);
            values.push(value ?? 0);
        }
        datasets.push({ label: `${school} - ${sub} - ${final}`, data: values });
        }
    }

    if (compareChartInstance) compareChartInstance.destroy();
    const ctx = document.getElementById("compareChart").getContext("2d");
    compareChartInstance = new Chart(ctx, {
        type: 'bar',
        data: { labels, datasets },
        options: {
        responsive: true,
        plugins: {
            legend: { position: 'top' },
            title: { display: true, text: `${school} í•­ëª© ì—°ë„ë³„ ë¹„êµ` }
        }
        }
    });
    }

  </script>
</body>
</html>
